<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ログイン履歴 | Wivid Admin</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 100px auto 40px;
            padding: 40px;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }
        
        .admin-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-accent);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: var(--color-bg-card);
            border-radius: 12px;
            padding: 24px;
            border: 2px solid var(--color-border);
        }
        
        .stat-label {
            color: var(--color-text-muted);
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .stat-value {
            color: var(--color-accent);
            font-size: 32px;
            font-weight: 700;
        }
        
        .history-table {
            width: 100%;
            background: var(--color-bg-card);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .history-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .history-table th {
            background: var(--color-primary);
            color: var(--color-accent);
            padding: 16px;
            text-align: left;
            font-weight: 700;
            border-bottom: 2px solid var(--color-accent);
        }
        
        .history-table td {
            padding: 16px;
            border-bottom: 1px solid var(--color-border);
            color: var(--color-text);
        }
        
        .history-table tr:hover {
            background: var(--color-bg-card-hover);
        }
        
        .time-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: var(--color-blue);
            color: white;
        }
    </style>
    
    <!-- Firebase認証チェック -->
    <script type="module">
        import { checkAuthState } from './auth.js';
        
        checkAuthState((authState) => {
            if (!authState.authenticated) {
                window.location.href = 'login.html';
            } else {
                document.body.style.display = 'block';
            }
        });
    </script>
    
    <style>
        body { display: none; }
    </style>
</head>
<body>
    <!-- ナビゲーション -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <span class="logo-text">Wivid</span>
                <span class="logo-badge">HP</span>
            </a>
            <ul class="nav-links">
                <li><a href="index.html">HP一覧</a></li>
                <li><a href="admin.html">管理画面</a></li>
                <li><a href="import.html">CSV一括インポート</a></li>
                <li><a href="login-history.html" style="color: #FFF100;">ログイン履歴</a></li>
                <li><a href="#" id="signOutBtn">ログアウト</a></li>
            </ul>
            <span class="nav-label" id="userEmail">ログイン履歴</span>
        </div>
    </nav>

    <div class="admin-container">
        <div class="admin-header">
            <h1 class="admin-title">ログイン履歴</h1>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">総ログイン数</div>
                <div class="stat-value" id="totalLogins">—</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ユニークユーザー数</div>
                <div class="stat-value" id="uniqueUsers">—</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">今日のログイン</div>
                <div class="stat-value" id="todayLogins">—</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">直近のログイン</div>
                <div class="stat-value" id="lastLogin" style="font-size: 18px;">—</div>
            </div>
        </div>
        
        <div class="history-table">
            <table>
                <thead>
                    <tr>
                        <th>ログイン日時</th>
                        <th>ユーザー</th>
                        <th>メールアドレス</th>
                        <th>ブラウザ情報</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 40px; color: #999;">
                            データを読み込み中...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { signOutUser, getCurrentUser } from './auth.js';
        
        // Firebase設定
        const firebaseConfig = {
          apiKey: "AIzaSyAWHDKSGNB4t0SF85lE9UNSwzdOJFFu4GA",
          authDomain: "wivid-hp-lp.firebaseapp.com",
          projectId: "wivid-hp-lp",
          storageBucket: "wivid-hp-lp.firebasestorage.app",
          messagingSenderId: "28034725256",
          appId: "1:28034725256:web:18bf22169697ff522df63d",
          measurementId: "G-MTT48T3EDP"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // ログイン履歴を読み込み
        async function loadLoginHistory() {
            const tbody = document.getElementById('historyTableBody');
            
            try {
                const q = query(collection(db, 'login_history'), orderBy('login_at', 'desc'), limit(100));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #999;">ログイン履歴がありません。</td></tr>';
                    return;
                }
                
                tbody.innerHTML = '';
                
                const emails = new Set();
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                let todayCount = 0;
                let lastLoginTime = null;
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    
                    const loginDate = data.login_at ? data.login_at.toDate() : null;
                    const formattedDate = loginDate ? loginDate.toLocaleString('ja-JP') : '—';
                    const browserInfo = parseBrowser(data.user_agent || '');
                    
                    // 統計用
                    emails.add(data.user_email);
                    if (loginDate && loginDate >= today) {
                        todayCount++;
                    }
                    if (!lastLoginTime && loginDate) {
                        lastLoginTime = formattedDate;
                    }
                    
                    row.innerHTML = `
                        <td><span class="time-badge">${formattedDate}</span></td>
                        <td>${data.user_name || '—'}</td>
                        <td>${data.user_email || '—'}</td>
                        <td style="font-size: 12px; color: #999;">${browserInfo}</td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                // 統計を更新
                document.getElementById('totalLogins').textContent = querySnapshot.size;
                document.getElementById('uniqueUsers').textContent = emails.size;
                document.getElementById('todayLogins').textContent = todayCount;
                document.getElementById('lastLogin').textContent = lastLoginTime || '—';
                
            } catch (error) {
                console.error('データ読み込みエラー:', error);
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #E4007F;">データの読み込みに失敗しました。</td></tr>';
            }
        }
        
        // User Agentをパース
        function parseBrowser(ua) {
            if (!ua) return '不明';
            
            let browser = '不明';
            let os = '不明';
            
            if (ua.includes('Chrome')) browser = 'Chrome';
            else if (ua.includes('Safari')) browser = 'Safari';
            else if (ua.includes('Firefox')) browser = 'Firefox';
            else if (ua.includes('Edge')) browser = 'Edge';
            
            if (ua.includes('Mac')) os = 'macOS';
            else if (ua.includes('Windows')) os = 'Windows';
            else if (ua.includes('iPhone')) os = 'iPhone';
            else if (ua.includes('Android')) os = 'Android';
            
            return `${browser} / ${os}`;
        }
        
        // ユーザー情報を表示
        const user = getCurrentUser();
        if (user) {
            document.getElementById('userEmail').textContent = user.email;
        }
        
        // ログアウトボタン
        document.getElementById('signOutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            if (confirm('ログアウトしますか？')) {
                await signOutUser();
                window.location.href = 'login.html';
            }
        });
        
        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            loadLoginHistory();
        });
    </script>
</body>
</html>

